{% load gwml2_forms %}
{# leaflet #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<div id="general_information" class="tab-pane fade in active">
    <div class="section">
        <table>
            <tr>
                <td><h4>Identification</h4></td>
            </tr>
            {% field_as_row form.id %}
            {% field_as_row form.water_point_reference %}
            {% field_as_row form.water_point_type %}
            <tr>
                <td><h4>Location Information</h4></td>
            </tr>
            {% field_as_row form.latitude '°' %}
            {% field_as_row form.longitude '°' %}
            {% field_as_row form.elevation 'm.o.a.d.' %}
            {% field_as_row form.country %}
            {% field_as_row form.address %}
        </table>
        <div id="map-location" style="width: 80%; height: 300px;">
        </div>
    </div>
    <div class="section">
        <table>
            <tr>
                <td><h4>Summary Information</h4></td>
            </tr>
            <tr>
                <td>{{ form.picture.label }}</td>
                <td>{{ form.picture }}</td>
            </tr>
            <tr>
                <td>{{ form.description.label }}</td>
                <td>{{ form.description }}</td>
            </tr>
        </table>
    </div>
    {% include "groundwater_form/_many-to-many.html" with id='documents' title='Documents' theform=document %}
</div>
<script>
    submitFunctions['general_information'] = function () {
        let data = {
            documents: submitFunctionsManyToMany['documents']()
        }
        $('#general_information .section').find('input,textarea,select').each(
            function () {
                data[$(this).attr('name')] = $(this).val()
            });

        {# get the picture file name #}
        let picture = $('#general_information #id_picture').get(0).files[0]
        if (picture) {
            data['picture'] = picture.name
        }
        return data
    }

    {# leaflet #}
    let map = L.map(
        'map-location'
    ).setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    {# Draw Control#}
    let layers = new L.FeatureGroup();
    map.addLayer(layers);
    map.addControl(new L.Control.Draw({
        draw: {
            marker: true,
            polyline: false,
            circle: false,
            rectangle: false,
            polygon: false,
            circlemarker: false
        },
        edit: false
    }));

    {# Draw Event #}
    const $lat = $('#id_latitude');
    const $lng = $('#id_longitude');
    let onDrag = function (e) {
        const latLng = e.target.getLatLng()
        $lat.val(latLng.lat)
        $lng.val(latLng.lng)
    }
    map.on('draw:created', function (e) {
        layers.clearLayers();
        var marker = new L.Marker(e.layer.getLatLng(), {draggable: true});
        marker.on('dragend', onDrag);
        layers.addLayer(marker)

        {# setup the input #}
        const latLng = e.layer.getLatLng()
        $lat.val(latLng.lat)
        $lng.val(latLng.lng)
    });

    $('#id_latitude, #id_longitude').change(function () {
        const latLng = {
            lat: $lat.val(),
            lng: $lng.val()
        }
        if (latLng.lat && latLng.lng) {
            let marker = layers.getLayers()[0];
            if (!layers.getLayers()[0]) {
                marker = new L.Marker(latLng, {draggable: true});
                marker.on('dragend', onDrag);
                layers.addLayer(marker)
            }
            marker.setLatLng(latLng);
        }
    })

</script>